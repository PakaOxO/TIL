## 09.2 운영체제의 큰 그림

### 운영체제의 심장, 커널

&nbsp;&nbsp;운영체제의 핵심 서비스를 담당하는 부분을 `커널(kernel)`이라고 부릅니다.

<br>

> 💡 운영체제의 핵심 서비스에는 자원에 접근하고 조작하는 기능, 프로그램이 안전하게 실행되게 하는 기능 등이 포함되어 있습니다. 운영체제 핵심 서비스에 대한 내용은 바로 이번 절 마지막에 조금 더 자세하게 다룹니다.

<br>

**사용자 인터페이스**

&nbsp;&nbsp;`사용자 인터페이스(user interface)`는 운영체제가 제공하지만 커널에 포함되지 않은 대표적인 서비스입니다. 사용자 인터페이스에는 그래픽을 기반으로 한 `그래픽 사용자 인터페이스(graphic user interface, GUI)`와 명령어를 기반으로 한 `커맨드 라인 인터페이스(command line interface, CLI)`로 나뉩니다.

<br>

### 이중 모드와 시스템 호출

&nbsp;&nbsp;CPU가 명령어를 실행하는 모드는 크게 `커널 모드(kernel mode)`와 `사용자 모드(user mode)` 두 가지로 나뉩니다. 운영체제는 여러 응용 프로그램이 자원에 직접 접근 함으로 발생할 수 있는 문제를 방지하기 위해 <mark>커널 영역의 코드를 실행할 수 있는 모드</mark>인 커널 모드를 별도로 분리하는 이중 모드 방식을 통해 운영체제 서비스를 제공받을 수 있도록 합니다.

<br>

**사용자 모드**

- 운영체제 서비스를 제공받을 수 없으며, 커널 영역의 코드를 실행할 수 없는 모드입니다.
- 일반적인 응용 프로그램은 사용자 모드로 실행됩니다.

<br>

**커널 모드**

- 운영체제 서비스를 제공받을 수 있는 모드로, 커널 영역의 코드를 실행할 수 있습니다.
- 운영체제는 커널 모드에서 실행되기 때문에 자원에 직접 접근할 수 있습니다.

<br>

> 💡 CPU가 사용자 모드로 실행 중인지, 커널 모드로 실행 중인지 알 수 있는 방법은 플래그 레지스터 속 슈퍼바이저 플래그를 보면 알 수 있습니다.

<br>

&nbsp;&nbsp;사용자 모드로 실행되는 프로그램은 운영체제에 요청을 보내 커널 모드로 전환하여 컴퓨터 자원에 접근하는 운영체제 서비스를 제공받을 수 있습니다. <mark>커널 모드로 전환하기 위해 운영체제에 보내는 요청</mark>을 `시스템 호출(system call)`이라고 합니다. 시스템 호출은 소프트웨어적인 인터럽트로 4장에서 다룬 인터럽트 처리 순서와 비슷합니다.

<br>

**일반적인 인터럽트 처리 순서**

1. 시스템 호출이 발생하면 기존에 작업하던 내용을 백업하고 커널 모드로 전환합니다.
2. 커널 모드를 통해 하드 디스크에 데이터를 저장하는 등의 자원을 활용하는 동작을 수행합니다.
3. 작업이 완료되었으면 다시 사용자 모드로 복귀합니다.

<br>

> 💡 시스템 호출의 종류
>
> 1. 프로세스 관리 : fork(), execve(), exit(), waitpid()
> 2. 파일 관리 : open(), clase(), read(), write(), stat()
> 3. 디렉토리 관리 : chdir(), mkdir(), rmdir()
> 4. 파일 시스템 관리 : mount(), unmount()

<br>

### 운영체제의 핵심 서비스

1. **프로세스 관리**

- `프로세스`는 실행 중인 프로그램을 가리킵니다.

- 하나의 CPU는 한번에 하나의 프로세스만 실행할 수 있어 일반적으로 실행 중인 프로세스들을 번갈아 가면서 실행합니다.

- 운영체제는 다양한 프로세스들을 관리하고 실행할 수 있어야 합니다.

- 운영체제는 여러 프로세스가 동시에 실행되는 환경에서는 `프로세스 동기화`가 필수적이고, 프로세스가 더 이상 실행하지 못하는 상황인 `교착 상태`를 해결해야 합니다. 프로세스 동기화와 교착 상태에 대해서는 이후 장에서 다룹니다.

  <br>

2. **자원 접근 및 할당**

- `CPU`는 한번에 하나의 프로세스만을 실행할 수 있기 때문에 운영체제는 `CPU 스케줄링`을 통해 실행 중인 프로세스들에 CPU를 공정하게 할당합니다.

- `메모리`에 적재되는 프로세스들은 각각 크기와 적재되는 주소가 다르며, 실행될 때마다 적재되는 주소가 바뀌기도 합니다. 운영체제는 프로세스에 적절하게 메모리를 할당할 수 있는 서비스를 제공하며, 메모리가 부족할 때 이를 극복하기 위한 기능을 제공합니다.

- `입출력장치`에 의해 발생하는 하드웨어 인터럽트는 운영체제가 제공하는 기능인 인터럽트 서비스 루틴처럼 커널 영역에 있습니다. 하드웨어 인터럽트가 발생하면 커널 모드로 전환되어 기존의 작업을 백업한 뒤 입출력 작업을 수행합니다.

<br>

3. **파일 시스템 관리**

- 파일을 열고, 생성하고, 삭제하는 기능, 파일과 파일들을 묶어 보조장치에 폴더(directory)로 관리하는 `파일 시스템(file system)` 역시 운영체제가 지원하는 핵심 서비스입니다.

<br>

### 가상 머신과 이중 모드

> ❗️ `가상 머신(virtual machine)`은 소프트웨어적으로 만든 가상 컴퓨터로 가상 머신을 통해 새로운 운영체제와 응용 프로그램을 설치하고 실행하는 것이 가능합니다.

<br>

&nbsp;&nbsp;가상 머신 역시 응용 프로그램이기 때문에 사용자 모드로 실행됩니다. 가상 머신에 설치된 리눅스가 있고, 그 위에 하나의 응용 프로그램이 운영체제(리눅스)에 파일 시스템에 접근을 요청해 커널 모드로 전환되어야 하겠지만 가상 머신에 설치된 운영체제도 사용자 모드로 실행된다면 운영체제 서비스를 제공받기 어렵습니다.

<br>

**하이퍼바이저 모드**

&nbsp;&nbsp;가상화를 지원하는 CPU에서는 커널 모드와 사용자 모드 이외에 `하이퍼바이저 모드`를 두어 가상 머신을 위한 모드를 별도로 제공합니다. 가상 머신 위에서 실행되는 응용 프로그램들은 하이퍼바이저 모드로써 가상 머신에 설치된 운영체제로 부터 운영체제 서비스를 제공받을 수 있습니다.

<br>
